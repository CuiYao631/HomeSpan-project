# HomeKit 智能插座

基于 HomeSpan 的 ESP32 HomeKit 智能插座，支持4路独立控制和全局开关功能。

## 功能特性
- HomeKit 插座服务（Outlet）
- 4个独立可控插座
- IO0按钮全开/全关控制
- LED状态指示
- 继电器安全控制
- HomeKit远程控制
- Siri语音控制

## 硬件接线
| 功能         | 引脚      | 说明                    |
| ------------ | --------- | ----------------------- |
| 插座1控制     | GPIO2     | 控制继电器1              |
| 插座2控制     | GPIO4     | 控制继电器2              |
| 插座3控制     | GPIO5     | 控制继电器3              |
| 插座4控制     | GPIO18    | 控制继电器4              |
| 全局控制按钮  | GPIO0     | 全开/全关按钮            |
| LED状态指示   | GPIO19    | 插座状态指示灯           |

### 继电器模块连接
- **VCC**: 连接5V电源
- **GND**: 连接GND
- **IN1-IN4**: 分别连接GPIO2, GPIO4, GPIO5, GPIO18
- **COM**: 连接电源火线
- **NO**: 连接插座火线输出

⚠️ **安全警告**: 涉及220V交流电，请确保断电操作，建议请专业电工安装！

## 使用说明

### 基本操作
1. 烧录代码到 ESP32
2. 通过 HomeKit 添加配件，名称为"智能插座组"
3. 在 HomeKit App 中可看到4个独立插座
4. 每个插座可单独开关控制

### 物理控制
- **IO0按钮**: 短按切换全开/全关状态
- **智能逻辑**: 
  - 如果有任何插座开启 → 按钮会关闭所有插座
  - 如果所有插座关闭 → 按钮会开启所有插座

### LED状态指示
- **LED熄灭**: 所有插座关闭
- **LED常亮**: 所有插座开启
- **LED闪烁**: 部分插座开启

### HomeKit功能
- **单独控制**: 每个插座可独立开关
- **Siri控制**: "嘿Siri，打开插座1"
- **自动化**: 基于时间、传感器等条件自动控制
- **远程控制**: 通过家庭中枢远程操作

## HomeKit 配置

### 在家庭App中的显示
- 主设备: "智能插座组"
- 子设备: "插座1", "插座2", "插座3", "插座4"
- 每个插座显示开关状态和使用状态

### 自动化建议
```
场景1: 离家模式
- 触发: 最后一人离家
- 动作: 关闭所有插座

场景2: 回家模式  
- 触发: 有人回家
- 动作: 开启常用插座(插座1、插座2)

场景3: 夜间模式
- 触发: 晚上11点
- 动作: 关闭娱乐设备插座，保留必要插座

场景4: 节能模式
- 触发: 手动触发或定时
- 动作: 关闭非必要插座
```

## 安全特性
- **继电器控制**: 硬件级别的开关控制
- **状态同步**: HomeKit状态与硬件状态实时同步
- **防误触**: 按钮防抖处理
- **状态指示**: LED直观显示当前状态

## 故障排查

### 常见问题
**Q: 某个插座无法控制？**
A: 检查对应GPIO引脚连接，确认继电器模块供电正常。

**Q: HomeKit显示离线？**
A: 检查WiFi连接，重启ESP32，确保网络稳定。

**Q: IO0按钮无响应？**
A: 检查按钮接线，确认GPIO0连接正确，查看串口调试信息。

**Q: LED状态异常？**
A: 检查GPIO19连接，确认LED正负极接线正确。

### 调试技巧
1. **串口监控**: 查看详细的开关状态和调试信息
2. **逐一测试**: 先测试单个插座，再测试全局控制
3. **HomeKit重置**: 如遇问题可重新配对设备
4. **继电器测试**: 用万用表测试继电器触点通断

## 扩展功能
- 添加电流检测，实现真正的OutletInUse状态
- 集成功率计量芯片，监控耗电量
- 添加过载保护功能
- 支持定时开关功能
- 添加更多物理按钮，控制单个插座

## 参考资料
- [HomeSpan Outlet 文档](https://github.com/HomeSpan/HomeSpan/blob/master/docs/ServiceList.md#outlet-47)
- [HomeKit 插座服务规范](https://developer.apple.com/documentation/homekit/hmservice/outlet)
- [继电器模块使用指南](https://www.arduino.cc/en/Tutorial/BuiltInExamples/Button)

---

⚠️ **重要提醒**: 本项目涉及高压电路，安装和使用时务必注意安全，建议由专业人员进行安装调试。