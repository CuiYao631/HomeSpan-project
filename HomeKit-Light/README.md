# HomeKit 智能灯

基于 HomeSpan 的 ESP32 HomeKit 智能灯，支持HomeKit控制和物理开关控制。

## 功能特性
- HomeKit 灯泡服务（LightBulb）
- 低电平触发灯光控制
- 物理开关按钮控制
- LED状态指示灯
- HomeKit远程控制
- Siri语音控制

## 硬件接线
| 功能         | 引脚      | 说明                    |
| ------------ | --------- | ----------------------- |
| 灯光控制     | GPIO4     | 控制继电器/LED (低电平触发开启) |
| 物理开关     | GPIO0     | 物理按钮开关            |
| LED指示灯    | GPIO32    | 状态指示 (低电平点亮)    |

### 详细接线说明

#### 灯光控制 (GPIO4)
- **继电器模块**: GPIO4 → 继电器IN端，低电平触发
- **直接LED**: GPIO4 → LED负极 (通过限流电阻)

#### 物理开关 (GPIO0)
- **按钮开关**: 一端接GPIO0，另一端接GND
- **内置上拉**: 代码中已启用INPUT_PULLUP

#### LED指示灯 (GPIO32)
- **指示LED**: GPIO32 → LED负极 (通过限流电阻)，正极接3.3V
- **状态显示**: 低电平时LED点亮表示灯光开启

## 工作原理

### 控制逻辑
- **灯光控制**: GPIO4输出低电平时灯光开启，高电平时关闭
- **状态指示**: GPIO32输出低电平时LED指示灯点亮
- **物理开关**: GPIO0检测到低电平时切换灯光状态

### 状态同步
- HomeKit控制 ↔ 硬件状态 ↔ LED指示
- 物理开关操作会同步更新HomeKit状态
- 所有控制方式状态保持一致

## 使用说明

### 基本操作
1. 烧录代码到 ESP32
2. 通过 HomeKit 添加配件，名称为"智能灯"
3. 在 HomeKit App 中控制灯光开关
4. 使用物理按钮也可控制灯光

### HomeKit功能
- **开关控制**: 在家庭App中点击开关灯光
- **Siri控制**: "嘿Siri，打开智能灯"
- **自动化**: 基于时间、位置、传感器等条件
- **远程控制**: 通过家庭中枢远程操作

### 物理控制
- **按钮操作**: 短按GPIO0按钮切换灯光状态
- **防抖处理**: 200ms防抖，避免误触
- **状态同步**: 物理操作会同步到HomeKit

## 应用场景

### 家庭照明
```
场景1: 回家模式
- 触发: 有人回家
- 动作: 自动开启玄关灯

场景2: 离家模式
- 触发: 最后一人离家
- 动作: 关闭所有灯光

场景3: 夜间模式
- 触发: 晚上10点
- 动作: 关闭主灯，开启夜灯

场景4: 起床模式
- 触发: 早上7点
- 动作: 逐渐开启卧室灯光
```

### 智能联动
- 与运动传感器联动：检测到人时自动开灯
- 与门窗传感器联动：开门时自动开启走廊灯
- 与安全系统联动：报警时开启所有灯光
- 与环境传感器联动：根据光照强度自动调节

## 扩展功能

### 可扩展的功能
1. **亮度调节**: 添加PWM控制实现调光
2. **颜色控制**: 使用RGB LED实现变色
3. **多路控制**: 控制多个灯光回路
4. **定时功能**: 内置定时开关功能
5. **能耗监测**: 添加电流传感器监测功耗

### 硬件升级建议
- 使用光敏电阻自动调节亮度
- 添加红外遥控接收器
- 集成温湿度传感器
- 使用可调光LED驱动器

## 故障排查

### 常见问题
**Q: 灯光无法控制？**
A: 检查GPIO4接线，确认继电器或LED连接正确，检查电源供应。

**Q: 物理开关无响应？**
A: 检查GPIO0接线，确认按钮连接到GND，检查代码中的INPUT_PULLUP设置。

**Q: LED指示灯不亮？**
A: 检查GPIO32接线，确认LED正负极接线正确，检查限流电阻。

**Q: HomeKit显示离线？**
A: 检查WiFi连接，重启ESP32，确保网络稳定。

### 调试步骤
1. **串口监控**: 查看ESP32启动和运行状态
2. **硬件测试**: 用万用表测试各引脚电压
3. **逐步测试**: 先测试基本功能，再测试HomeKit集成
4. **重新配对**: 删除设备后重新添加到HomeKit

## 安全注意事项
- 如涉及交流电，请确保断电操作
- 使用合适的继电器模块
- 注意电流容量匹配
- 建议专业人员安装

## 参考资料
- [HomeSpan LightBulb 文档](https://github.com/HomeSpan/HomeSpan/blob/master/docs/ServiceList.md)
- [HomeKit 灯泡服务规范](https://developer.apple.com/documentation/homekit/hmservice/lightbulb)
- [ESP32 GPIO 使用指南](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/gpio.html)

---

💡 这是一个基础的智能灯实现，可以根据具体需求扩展更多功能。