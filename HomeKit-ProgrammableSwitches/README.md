# HomeKit 可编程开关 (Programmable Switches)

基于 HomeSpan 库开发的 HomeKit 可编程开关设备，支持多种按键操作和场景控制。

## 功能特性

### 核心功能
- **4个独立开关**: 每个开关支持独立的事件触发
- **多种按键操作**: 单击、双击、长按三种操作模式
- **HomeKit集成**: 完全兼容苹果HomeKit生态系统
- **场景控制**: 可用于触发HomeKit场景和自动化
- **LED状态指示**: 实时显示设备连接和运行状态

### HomeKit服务
- **StatelessProgrammableSwitch**: 可编程开关服务
- **ProgrammableSwitchEvent**: 开关事件特性
  - 0: 单击事件
  - 1: 双击事件  
  - 2: 长按事件
- **Name**: 开关名称特性
- **AccessoryInformation**: 设备信息服务

## 硬件要求

### 必需组件
- ESP32 开发板 × 1
- 按钮开关 × 4
- LED指示灯 × 1
- 连接线若干

### 引脚连接
```
ESP32 引脚    连接设备        说明
GPIO0        开关1          场景开关1 (内置上拉)
GPIO2        开关2          场景开关2 (内置上拉)  
GPIO4        开关3          场景开关3 (内置上拉)
GPIO5        开关4          场景开关4 (内置上拉)
GPIO32       LED指示灯      HomeKit状态显示
VCC          电源正极        3.3V/5V
GND          电源负极        公共地线
```

### 接线图
```
ESP32                    按钮开关
┌─────────────┐         ┌──────┐
│ GPIO0       ├─────────┤ SW1  │
│ GPIO2       ├─────────┤ SW2  │
│ GPIO4       ├─────────┤ SW3  │
│ GPIO5       ├─────────┤ SW4  │
│ GPIO32      ├─────────┤ LED  │
│ GND         ├─────────┤ GND  │
└─────────────┘         └──────┘
```

## 软件配置

### 库依赖
```cpp
#include "HomeSpan.h"      // HomeKit核心库
#include <Arduino.h>       // Arduino核心库
#include <EasyButton.h>    // 按钮处理库
```

### 重要参数
```cpp
#define DEFAULT_SETUP_CODE "46637726"  // HomeKit配对码
#define DEFAULT_QR_ID      "PSWS"      // QR码ID
const int longPressDuration = 3000;    // 长按触发时间
const int doubleClickGap = 300;        // 双击间隔时间
```

## 使用说明

### 设备配对
1. 编译并上传代码到ESP32
2. 设备启动后自动创建WiFi接入点
3. 使用iPhone/iPad打开"家庭"App
4. 点击"+"添加配件
5. 扫描QR码或输入配对码: `46637726`
6. 按照提示完成配对

### 操作方式
- **单击**: 快速按下并释放按钮
- **双击**: 在300ms内连续按下两次
- **长按**: 按住按钮3秒以上

### 场景设置
1. 在家庭App中创建场景
2. 添加触发条件为"配件被控制时"
3. 选择对应的可编程开关
4. 选择触发事件(单击/双击/长按)
5. 设置要执行的动作

## 应用场景

### 智能家居控制
- **客厅控制面板**: 控制灯光、电视、空调等设备
- **卧室床头开关**: 一键设置睡眠场景
- **门厅开关**: 回家/离家场景切换
- **紧急开关**: 一键关闭所有电器

### 场景示例
```
开关1 - 单击: 打开客厅灯
开关1 - 双击: 打开所有客厅设备  
开关1 - 长按: 客厅电影模式

开关2 - 单击: 调节亮度
开关2 - 双击: 切换色温
开关2 - 长按: 关闭所有灯光

开关3 - 单击: 播放音乐
开关3 - 双击: 暂停音乐
开关3 - 长按: 关闭音响

开关4 - 单击: 回家场景
开关4 - 双击: 离家场景
开关4 - 长按: 睡眠场景
```

## 技术特点

### 硬件特性
- **低功耗设计**: 优化的ESP32功耗管理
- **稳定通信**: 可靠的WiFi连接和HomeKit通信
- **多按钮支持**: 同时处理4个独立按钮
- **实时响应**: 毫秒级的按键响应时间

### 软件特性
- **事件驱动**: 基于EasyButton库的高效事件处理
- **状态管理**: 完整的设备状态跟踪和管理
- **错误处理**: 完善的异常处理和恢复机制
- **调试支持**: 详细的串口调试信息

## 故障排除

### 常见问题
1. **设备无法配对**
   - 检查WiFi网络是否正常
   - 确认配对码是否正确
   - 重启设备后重试

2. **按键无响应**
   - 检查按钮接线是否正确
   - 确认GPIO引脚连接无误
   - 查看串口调试信息

3. **HomeKit连接不稳定**
   - 检查WiFi信号强度
   - 确认路由器设置正确
   - 重置HomeKit配对数据

### 调试方法
- 打开串口监视器(115200波特率)
- 观察设备启动和运行日志
- 检查按键事件触发信息

## 扩展功能

### 可定制选项
- **增加更多开关**: 可扩展到更多GPIO引脚
- **自定义事件**: 添加更多按键组合
- **状态反馈**: 增加更多LED指示功能
- **无线升级**: 支持OTA固件更新

### 进阶应用
- **传感器集成**: 结合温湿度、光照传感器
- **定时功能**: 添加定时控制逻辑
- **联动控制**: 与其他HomeKit设备联动
- **数据记录**: 记录使用统计数据

---

## 版本信息
- **版本**: v1.0.0
- **作者**: XcuiTech Inc.
- **更新日期**: 2024年
- **许可证**: MIT License